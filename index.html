<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>test51</title>
  <style>
    html, body {
      margin:0; padding:0; height:100%;
      overflow-x: hidden;
      background:#eef2f3; font-family:Arial,sans-serif;
      max-width: 100vw;
    }
    #createObjectBtn, #startBtn {
      position:absolute; top:20px; padding:12px 20px; border-radius:6px; font-size:16px; cursor:pointer;
      box-shadow:0 4px 8px rgba(0,0,0,0.3); border:3px solid transparent; user-select:none;
      z-index:1000;
    }
    #createObjectBtn {
      left:20px; background:#e67e22; color:#fff; border-color:#d35400;
    }
    #startBtn {
      left:140px; background:#27ae60; color:#fff; border-color:#1e8449;
    }
    #startBtn.running {
      background:#c0392b; border-color:#922b21;
    }
    #ground {
      position:absolute; bottom:0; left:0; width:100%; height:120px;
      background:linear-gradient(90deg,#7f8c8d,#bdc3c7);
      border-top:3px solid #2c3e50; z-index:10;
    }
    #simulator {
      position:absolute; top:0; left:0; width:100%; height:calc(100% - 120px);
      background:#fff; z-index:20;
      overflow-x: hidden; max-width: 100vw;
    }
    #followBox {
      position:absolute; width:60px; height:60px;
      background:rgba(52,152,219,0.5); border-radius:6px;
      display:none; z-index:900; transform:translate(-50%,0);
    }
    .object {
      position:absolute; width:60px; height:60px;
      background:#3498db; border:2px solid #2c3e50; border-radius:6px;
      display:flex; align-items:center; justify-content:center;
      flex-direction:column; cursor:pointer; user-select:none;
      z-index:800; color:#fff; font-size:12px;
      box-sizing: border-box;
    }
    .label-text { font-size:14px; color:#fff; pointer-events:none; user-select:none; }
    .input-container { display:flex; flex-direction:column; gap:4px; width:100%; }
    .input-with-unit { position:relative; width:100%; }
    .input-with-unit input {
      width:100%; font-size:12px; padding-right:28px; box-sizing:border-box;
      text-align: right;
    }
    .input-with-unit span {
      position:absolute; right:4px; top:50%; transform:translateY(-50%);
      font-size:10px; color:#555; pointer-events:none;
    }
    .done-btn {
      position:absolute; width:60px; font-size:12px; padding:3px 0;
      border:1px solid #1e8449; background:#27ae60; color:#fff;
      border-radius:4px; cursor:pointer; z-index:1001;
      top: -30px; left: 0;
    }
    #alertBox {
      position:fixed; top:-50px; left:50%; transform:translateX(-50%);
      background:rgba(231,76,60,0.7); color:#fff;
      padding:12px 24px; border-radius:6px; font-weight:bold;
      box-shadow:0 2px 6px rgba(0,0,0,0.3); z-index:2000;
      opacity:0.85; animation-fill-mode:forwards;
      user-select:none;
    }
    @keyframes dropDown {
      0% { top:-50px; opacity:0 }
      50%,100% { top:20px; opacity:1 }
    }
    @keyframes fadeOut {
      from { opacity:1 } to { opacity:0 }
    }
    .arrow {
      position:absolute; font-size:72px; font-weight:bold; color:#000;
      cursor:pointer; user-select:none; z-index:700;
      pointer-events: auto;
      transition: left 0.1s ease;
    }
    .wall {
      position: absolute;
      top: 0; bottom: 120px; width: 10px;
      background: #2c3e50;
      z-index: 900;
    }
    #leftWall { left: 0; }
    #rightWall { right: 0; }
  </style>
</head>
<body>
  <button id="createObjectBtn">물체 생성</button>
  <button id="startBtn">시작</button>
  <div id="simulator">
    <div id="followBox"></div>
  </div>
  <div id="ground"></div>
  <div id="alertBox" style="display:none;"></div>
  <div id="leftWall" class="wall"></div>
  <div id="rightWall" class="wall"></div>

  <script>
    const createBtn = document.getElementById('createObjectBtn');
    const startBtn = document.getElementById('startBtn');
    const followBox = document.getElementById('followBox');
    const simulator = document.getElementById('simulator');
    const alertBox = document.getElementById('alertBox');
    const leftWall = document.getElementById('leftWall');
    const rightWall = document.getElementById('rightWall');

    let tracking = false;
    let delayPassed = false;
    let objects = [];
    let animationId = null;
    let running = false;

    function showAlert(msg) {
      alertBox.textContent = msg;
      alertBox.style.display = 'block';
      alertBox.style.animation = 'dropDown 0.5s forwards';
      setTimeout(() => {
        alertBox.style.animation = 'fadeOut 0.5s forwards';
      }, 2500);
      alertBox.addEventListener('animationend', () => {
        if (alertBox.style.opacity === '0') {
          alertBox.style.display = 'none';
          alertBox.style.animation = '';
        }
      }, { once: true });
    }

    function getBoxY() {
      const groundHeight = 120;
      const boxHeight = 60;
      const offset = -2; // 살짝 공중에 띄움
      return window.innerHeight - groundHeight - boxHeight + offset;
    }

    function followMouse(e) {
      const y = getBoxY();
      followBox.style.left = e.clientX + 'px';
      followBox.style.top = y + 'px';
    }

    function stopTracking() {
      tracking = false; delayPassed = false;
      followBox.style.display = 'none';
      createBtn.textContent = '물체 생성';
      window.removeEventListener('mousemove', followMouse);
      window.removeEventListener('click', handleClickOnce);
    }

    function handleClickOnce(e) {
      if (!delayPassed) return;
      if (!tracking) return;
      const x = e.clientX - 30;
      const y = getBoxY();

      const box = createObjectBox(x, y);
      simulator.appendChild(box);
      objects.push(box);

      stopTracking();
    }

    function createObjectBox(x, y) {
      const box = document.createElement('div');
      box.className = 'object';
      box.style.left = x + 'px';
      box.style.top = y + 'px';

      box.mass = '';
      box.velocity = '';
      box.direction = '→'; // 기본 오른쪽

      // 화살표 생성
      const arrow = document.createElement('div');
      arrow.className = 'arrow';
      arrow.textContent = box.direction;
      simulator.appendChild(arrow);

      updateArrowPosition(box, arrow);

      arrow.addEventListener('click', e => {
        e.stopPropagation();
        box.direction = (box.direction === '→') ? '←' : '→';
        arrow.textContent = box.direction;
        updateArrowPosition(box, arrow);
      });

      // 입력창 및 완료 버튼 함수
      function makeInputs(massVal, velVal) {
        const container = document.createElement('div');
        container.className = 'input-container';

        [['질량', 'kg', massVal], ['속도', 'm/s', velVal]].forEach(([ph, unit, val]) => {
          const row = document.createElement('div');
          row.className = 'input-with-unit';

          const input = document.createElement('input');
          input.type = 'number';
          input.placeholder = ph;
          input.value = val || '';
          input.min = 0;
          input.step = 'any';

          const span = document.createElement('span');
          span.textContent = unit;

          row.appendChild(input);
          row.appendChild(span);
          container.appendChild(row);
        });

        return {
          container,
          massInput: container.children[0].querySelector('input'),
          velInput: container.children[1].querySelector('input')
        };
      }

      // 초기 입력창 생성
      let savedData = { mass: '', velocity: '', direction: box.direction };
      let inputContainer, massInput, velInput, doneBtn;

      function openInputs() {
        if (box.querySelector('.input-container')) return; // 이미 열려있으면 무시

        const inputs = makeInputs(savedData.mass, savedData.velocity);
        inputContainer = inputs.container;
        massInput = inputs.massInput;
        velInput = inputs.velInput;

        box.appendChild(inputContainer);

        doneBtn = document.createElement('button');
        doneBtn.className = 'done-btn';
        doneBtn.textContent = '완료';
        box.appendChild(doneBtn);

        doneBtn.onclick = () => {
          const m = massInput.value.trim();
          const v = velInput.value.trim();

          if (m === '' && v === '') {
            showAlert('질량과 속도를 입력해 주세요');
            return;
          }
          if (m === '') {
            showAlert('질량을 입력해 주세요');
            return;
          }
          if (v === '') {
            showAlert('속도를 입력해 주세요');
            return;
          }

          savedData.mass = m;
          savedData.velocity = v;
          savedData.direction = box.direction;

          box.mass = parseFloat(m);
          box.velocity = parseFloat(v);
          box.direction = savedData.direction;

          // 입력창 및 완료 버튼 제거
          inputContainer.remove();
          doneBtn.remove();

          // 라벨 텍스트 업데이트
          let label = box.querySelector('.label-text');
          if (!label) {
            label = document.createElement('div');
            label.className = 'label-text';
            box.appendChild(label);
          }
          label.textContent = `${m} kg`;

          arrow.style.display = 'block';
        };

        massInput.focus();
      }

      box.addEventListener('click', e => {
        e.stopPropagation();
        openInputs();
      });

      // 초기 라벨
      const label = document.createElement('div');
      label.className = 'label-text';
      box.appendChild(label);

      arrow.style.display = 'block';

      // 이동 및 위치 업데이트용 메서드 추가
      box.arrow = arrow;
      box.savedData = savedData;

      return box;
    }

    function updateArrowPosition(box, arrow) {
      const gap = -10;
      const boxW = 60;

      const boxLeft = parseFloat(box.style.left);
      const boxTop = parseFloat(box.style.top);

      const arrowRect = arrow.getBoundingClientRect();

      if (arrow.textContent === '→') {
        arrow.style.left = (boxLeft + boxW + gap) + 'px';
      } else {
        arrow.style.left = (boxLeft - arrowRect.width - gap) + 'px';
      }
      arrow.style.top = (boxTop + (boxW - arrowRect.height) / 2) + 'px';
    }

    createBtn.addEventListener('click', () => {
      tracking = !tracking;
      delayPassed = false;

      if (tracking) {
        followBox.style.display = 'block';
        createBtn.textContent = '취소';
        window.addEventListener('mousemove', followMouse);
        setTimeout(() => delayPassed = true, 300);
        window.addEventListener('click', handleClickOnce);
      } else {
        stopTracking();
      }
    });

    startBtn.addEventListener('click', () => {
      running = !running;
      if (running) {
        startBtn.textContent = '중지';
        startBtn.classList.add('running');
        animate();
      } else {
        startBtn.textContent = '시작';
        startBtn.classList.remove('running');
        cancelAnimationFrame(animationId);
        animationId = null;
      }
    });

    function animate() {
      animationId = requestAnimationFrame(animate);

      // 이동 계산
      objects.forEach(box => {
        if (!box.velocity || isNaN(box.velocity) || box.velocity <= 0) return;

        let vel = parseFloat(box.velocity);
        let dir = box.direction === '→' ? 1 : -1;

        let left = parseFloat(box.style.left);
        const right = left + 60;

        // 벽 충돌 체크
        if (left <= 10) { // 왼쪽벽(두께10px)
          box.velocity = 0;
          box.direction = '→';
          box.arrow.textContent = '→';
          updateArrowPosition(box, box.arrow);
          return;
        }
        if (right >= window.innerWidth - 10) { // 오른쪽벽
          box.velocity = 0;
          box.direction = '←';
          box.arrow.textContent = '←';
          updateArrowPosition(box, box.arrow);
          return;
        }

        left += vel * dir;
        box.style.left = left + 'px';
        updateArrowPosition(box, box.arrow);
      });

      // 충돌 체크 (물체끼리)
      for (let i = 0; i < objects.length; i++) {
        for (let j = i + 1; j < objects.length; j++) {
          const a = objects[i];
          const b = objects[j];

          const aLeft = parseFloat(a.style.left);
          const aRight = aLeft + 60;
          const bLeft = parseFloat(b.style.left);
          const bRight = bLeft + 60;

          // 충돌여부 체크 (가로방향에서 겹침 판단)
          if (aRight > bLeft && aLeft < bRight) {
            // 운동량 보존 및 속도 계산
            if (!a.mass || !b.mass || isNaN(a.mass) || isNaN(b.mass)) continue;
            if (!a.velocity || !b.velocity || isNaN(a.velocity) || isNaN(b.velocity)) continue;

            const m1 = a.mass;
            const m2 = b.mass;
            let v1 = a.velocity * (a.direction === '→' ? 1 : -1);
            let v2 = b.velocity * (b.direction === '→' ? 1 : -1);

            // 1차원 완전 탄성 충돌 계산
            const newV1 = ((m1 - m2) * v1 + 2 * m2 * v2) / (m1 + m2);
            const newV2 = ((m2 - m1) * v2 + 2 * m1 * v1) / (m1 + m2);

            // 속도 업데이트 및 방향 전환
            a.velocity = Math.abs(newV1);
            a.direction = newV1 >= 0 ? '→' : '←';
            a.arrow.textContent = a.direction;

            b.velocity = Math.abs(newV2);
            b.direction = newV2 >= 0 ? '→' : '←';
            b.arrow.textContent = b.direction;

            updateArrowPosition(a, a.arrow);
            updateArrowPosition(b, b.arrow);

            // 충돌 후 위치 보정 (겹치지 않도록)
            if (aRight > bLeft) {
              const overlap = aRight - bLeft;
              // 서로 밀어냄
              a.style.left = (aLeft - overlap / 2) + 'px';
              b.style.left = (bLeft + overlap / 2) + 'px';
              updateArrowPosition(a, a.arrow);
              updateArrowPosition(b, b.arrow);
            }
          }
        }
      }
    }

    // 클릭하면 입력창 닫기 (빈 공간 클릭 시)
    window.addEventListener('click', () => {
      objects.forEach(box => {
        const ic = box.querySelector('.input-container');
        const btn = box.querySelector('.done-btn');
        if (ic) ic.remove();
        if (btn) btn.remove();
      });
    });

  </script>
</body>
</html>
