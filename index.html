<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>test62</title>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#eef2f3; font-family:Arial,sans-serif; }
    #createObjectBtn, #startStopBtn {
      position:absolute; top:20px; padding:12px 20px; border-radius:6px;
      font-size:16px; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.3);
      z-index:1000;
      user-select:none;
    }
    #leftWall, #rightWall {
  position: absolute;
  top: 0;
  width: 10px;  /* 벽 두께 */
  height: calc(100% - 120px); /* ground 제외한 시뮬레이터 높이 */
  background-color: #2c3e50;
  z-index: 30;
}

#leftWall {
  left: 0;
}

#rightWall {
  right: 0;
}
    #createObjectBtn {
      left:20px; background:#e67e22; color:#fff;
      border:3px solid #d35400;
    }
    #startStopBtn {
      left:140px; background:#27ae60; color:#fff;
      border:3px solid #1e8449;
    }
    #ground {
      position:absolute; bottom:0; left:0;
      width:100%; height:120px;
      background:linear-gradient(90deg,#7f8c8d,#bdc3c7);
      border-top:3px solid #2c3e50; z-index:10;
    }
    #simulator {
      position:absolute; top:0; left:0;
      width:100%; height:calc(100% - 120px);
      background:#fff; z-index:20;
      overflow: hidden;
    }
    #followBox {
      position:absolute; width:60px; height:60px;
      background:rgba(52,152,219,0.5); border-radius:6px;
      display:none; z-index:900; transform:translate(-50%,0);
      pointer-events:none;
    }
    .object {
      position:absolute; width:60px; height:60px;
      background:#3498db; border:2px solid #2c3e50; border-radius:6px;
      display:flex; align-items:center; justify-content:center;
      flex-direction:column; cursor:pointer; user-select:none;
      z-index:800; color:#fff; font-size:12px;
    }
    .label-text { font-size:14px; color:#fff; pointer-events:none; user-select:none; }
    .input-container { display:flex; flex-direction:column; gap:4px; width:100%; }
    .input-with-unit { position:relative; width:100%; }
    .input-with-unit input {
      width:100%; font-size:12px; padding-right:28px; box-sizing:border-box;
    }
    .input-with-unit span {
      position:absolute; right:4px; top:50%; transform:translateY(-50%);
      font-size:10px; color:#555; pointer-events:none;
    }
    .done-btn {
      position:absolute; width:60px; font-size:12px; padding:3px 0;
      border:1px solid #1e8449; background:#27ae60; color:#fff;
      border-radius:4px; cursor:pointer; z-index:1001;
      user-select:none;
    }
    #alertBox {
      position:fixed; top:-50px; left:50%; transform:translateX(-50%);
      background:rgba(231,76,60,0.85); color:#fff;
      padding:12px 24px; border-radius:6px; font-weight:bold;
      box-shadow:0 2px 6px rgba(0,0,0,0.3); z-index:2000;
      opacity:0.85; animation-fill-mode:forwards;
    }
    @keyframes dropDown {
      0% { top:-50px; opacity:0 }
      50%,100% { top:20px; opacity:1 }
    }
    @keyframes fadeOut {
      from { opacity:1 } to { opacity:0 }
    }
    .arrow {
      position:absolute; font-size:72px; font-weight:bold; color:#000;
      cursor:pointer; user-select:none; z-index:700;
      user-select:none;
    }
  </style>
</head>
<body>
  <button id="createObjectBtn">물체 생성</button>
  <button id="startStopBtn">시작</button>
  <div id="leftWall"></div>
  <div id="rightWall"></div>
  <div id="simulator"></div>
  <div id="ground"></div>
  <div id="followBox"></div>
  <div id="alertBox" style="display:none;"></div>
  <script>
    const btn = document.getElementById('createObjectBtn');
const startStopBtn = document.getElementById('startStopBtn');
const followBox = document.getElementById('followBox');
const simulator = document.getElementById('simulator');
const alertBox = document.getElementById('alertBox');
const groundHeight = 120;
const boxSize = 60;
const wallThickness = 10;

let tracking = false;
let delayPassed = false;
let moving = false;

const objects = [];
const arrows = [];

btn.addEventListener('click', () => {
  tracking = !tracking;
  delayPassed = false;
  if (tracking) {
    followBox.style.display = 'block';
    btn.textContent = '취소';
    window.addEventListener('mousemove', followMouse);
    setTimeout(() => delayPassed = true, 300);
    window.addEventListener('click', handleClickOnce);
  } else {
    stopTracking();
  }
});

function stopTracking() {
  tracking = false;
  delayPassed = false;
  followBox.style.display = 'none';
  btn.textContent = '물체 생성';
  window.removeEventListener('mousemove', followMouse);
  window.removeEventListener('click', handleClickOnce);
}

function followMouse(e) {
  const y = getBoxY();
  followBox.style.left = e.clientX + 'px';
  followBox.style.top = y + 'px';
}

function getBoxY() {
  return window.innerHeight - groundHeight - boxSize + -2;
}

function showAlert(msg) {
  alertBox.textContent = msg;
  alertBox.style.display = 'block';
  alertBox.style.animation = 'dropDown 0.5s forwards';
  setTimeout(() => alertBox.style.animation = 'fadeOut 0.5s forwards', 2500);
  alertBox.addEventListener('animationend', () => {
    if (alertBox.style.opacity === '0') {
      alertBox.style.display = 'none'; alertBox.style.animation = '';
    }
  }, { once: true });
}

function handleClickOnce(e) {
  if (!delayPassed) return;
  if (e.target === startStopBtn || e.target === btn) return;
  const x = e.clientX - boxSize / 2;
  const y = getBoxY();

  createObject(x, y);

  stopTracking();
}
function createObject(x, y) {
  const box = document.createElement('div');
  box.className = 'object';
  box.style.left = x + 'px';
  box.style.top = y + 'px';

  const arrow = document.createElement('div');
  arrow.className = 'arrow';
  arrow.textContent = '→';

  simulator.appendChild(box);
  simulator.appendChild(arrow);

  // 운동량 표시용 div 추가
  const momentumLabel = document.createElement('div');
  momentumLabel.className = 'label-text';
  momentumLabel.style.position = 'absolute';
  momentumLabel.style.top = '-20px';  // 물체 위쪽에 위치
  momentumLabel.style.width = '100%';
  momentumLabel.style.textAlign = 'center';
  momentumLabel.style.fontWeight = 'bold';
  momentumLabel.style.color = '#000';  // 검은색으로 눈에 띄게

  box.appendChild(momentumLabel);

  const data = {
    element: box,
    arrow: arrow,
    x: x,
    y: y,
    mass: '',
    velocity: '',
    direction: 1,
    moving: false,
    inputContainer: null,
    doneBtn: null,
    massInput: null,
    velocityInput: null,
    momentumLabel: momentumLabel, // 운동량 표시 요소 추가
  };

  arrows.push(arrow);
  objects.push(data);

  positionArrow(data);

  box.addEventListener('click', (ev) => {
    ev.stopPropagation();
    openInput(data);
  });

  arrow.addEventListener('click', (ev) => {
    ev.stopPropagation();
    toggleDirection(data);
  });
}

function positionArrow(data) {
  const gap = -10;
  const arrowRect = data.arrow.getBoundingClientRect();
  if (data.direction === 1) {
    data.arrow.style.left = (data.x + boxSize + gap) + 'px';
  } else {
    data.arrow.style.left = (data.x - arrowRect.width - gap) + 'px';
  }
  data.arrow.style.top = (data.y + (boxSize - arrowRect.height) / 2) + 'px';
  data.arrow.style.display = 'block';
}

function toggleDirection(data) {
  data.direction *= -1;
  data.arrow.textContent = data.direction === 1 ? '→' : '←';
  positionArrow(data);
}

function openInput(data) {
  if (data.inputContainer) return;

  const cont = document.createElement('div');
  cont.className = 'input-container';

  const massDiv = document.createElement('div');
  massDiv.className = 'input-with-unit';
  const massInput = document.createElement('input');
  massInput.type = 'number';
  massInput.placeholder = '질량';
  massInput.value = data.mass;
  const massSpan = document.createElement('span');
  massSpan.textContent = 'kg';
  massDiv.appendChild(massInput);
  massDiv.appendChild(massSpan);

  const velDiv = document.createElement('div');
  velDiv.className = 'input-with-unit';
  const velInput = document.createElement('input');
  velInput.type = 'number';
  velInput.placeholder = '속도';
  velInput.value = data.velocity;
  const velSpan = document.createElement('span');
  velSpan.textContent = 'm/s';
  velDiv.appendChild(velInput);
  velDiv.appendChild(velSpan);

  cont.appendChild(massDiv);
  cont.appendChild(velDiv);

  const doneBtn = document.createElement('button');
  doneBtn.className = 'done-btn';
  doneBtn.textContent = '완료';

  doneBtn.style.left = data.x + 'px';
  doneBtn.style.top = (data.y - 30) + 'px';

  simulator.appendChild(doneBtn);

  data.element.appendChild(cont);
  data.inputContainer = cont;
  data.doneBtn = doneBtn;
  data.massInput = massInput;
  data.velocityInput = velInput;

  massInput.focus();

  doneBtn.onclick = () => {
    const m = massInput.value.trim();
    const v = velInput.value.trim();
    if (m === '' || v === '') {
      showAlert('질량과 속도를 입력해 주세요');
      return;
    }

    data.mass = m;
    data.velocity = v;

    data.inputContainer.remove();
    data.inputContainer = null;
    data.doneBtn.remove();
    data.doneBtn = null;

    let lbl = data.element.querySelector('.label-text');
    if (!lbl) {
      lbl = document.createElement('div');
      lbl.className = 'label-text';
      data.element.appendChild(lbl);
    }
    lbl.textContent = `${m} kg`;

    data.arrow.style.display = 'block';
  };
}

startStopBtn.addEventListener('click', () => {
  moving = !moving;
  if (moving) {
    startStopBtn.textContent = '중지';
    startStopBtn.style.background = '#c0392b';
    startStopBtn.style.borderColor = '#922b21';
    startMovement();
  } else {
    startStopBtn.textContent = '시작';
    startStopBtn.style.background = '#27ae60';
    startStopBtn.style.borderColor = '#1e8449';
    stopMovement();
  }
});

let animationId = null;

function startMovement() {
  objects.forEach(obj => obj.moving = true);
  move();
}

function stopMovement() {
  objects.forEach(obj => obj.moving = false);
  if (animationId) {
    cancelAnimationFrame(animationId);
    animationId = null;
  }
}

function move() {
  // 1. 물체 위치 업데이트
  objects.forEach(obj => {
    if (!obj.moving) return;

    const vx = obj.velocity * obj.direction;
    let newX = obj.x + vx;

    // 벽 충돌 처리
    if (newX < wallThickness) {
      newX = wallThickness;
      obj.velocity = 0;
      obj.moving = false;
    } else if (newX > window.innerWidth - wallThickness - boxSize) {
      newX = window.innerWidth - wallThickness - boxSize;
      obj.velocity = 0;
      obj.moving = false;
    }

    obj.x = newX;
  });

  // 2. 충돌 감지 및 처리
  for (let i = 0; i < objects.length; i++) {
    for (let j = i + 1; j < objects.length; j++) {
      const objA = objects[i];
      const objB = objects[j];
      if (objA.x < objB.x + boxSize && objA.x + boxSize > objB.x) {
        // 충돌 발생

        const m1 = parseFloat(objA.mass) || 1;
        const m2 = parseFloat(objB.mass) || 1;
        const v1 = objA.velocity * objA.direction;
        const v2 = objB.velocity * objB.direction;

        // 1차원 탄성 충돌 공식
        const v1After = ((m1 - m2) / (m1 + m2)) * v1 + (2 * m2 / (m1 + m2)) * v2;
        const v2After = (2 * m1 / (m1 + m2)) * v1 + ((m2 - m1) / (m1 + m2)) * v2;

        objA.velocity = Math.abs(v1After);
        objA.direction = v1After >= 0 ? 1 : -1;
        objA.moving = objA.velocity > 0;

        objB.velocity = Math.abs(v2After);
        objB.direction = v2After >= 0 ? 1 : -1;
        objB.moving = objB.velocity > 0;

        // 겹침 보정
        const overlap = (objA.x + boxSize) - objB.x;
        objA.x -= overlap / 2;
        objB.x += overlap / 2;
      }
    }
  }

  // 3. 운동량 계산 및 표시
  objects.forEach(obj => {
    const massNum = parseFloat(obj.mass) || 0;
    const velocityNum = parseFloat(obj.velocity) || 0;
    const momentum = massNum * velocityNum;
    obj.momentumLabel.textContent = `운동량: ${momentum.toFixed(2)}`;
  });

  // 4. 화면 위치 및 화살표, 버튼 위치 업데이트
  objects.forEach(obj => {
    obj.element.style.left = obj.x + 'px';

    const arrowRect = obj.arrow.getBoundingClientRect();
    const gap = -10;
    if (obj.direction === 1) {
      obj.arrow.style.left = (obj.x + boxSize + gap) + 'px';
      obj.arrow.textContent = '→';
    } else {
      obj.arrow.style.left = (obj.x - arrowRect.width - gap) + 'px';
      obj.arrow.textContent = '←';
    }
    obj.arrow.style.top = (obj.y + (boxSize - arrowRect.height) / 2) + 'px';

    if (obj.doneBtn) {
      obj.doneBtn.style.left = obj.x + 'px';
      obj.doneBtn.style.top = (obj.y - 30) + 'px';
    }

    if (obj.inputContainer) {
      obj.inputContainer.style.left = obj.x + 'px';
      obj.inputContainer.style.top = obj.y + 'px';
    }
  });

  animationId = requestAnimationFrame(move);
}
  </script>
</body>
</html>
