<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>test52</title>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#eef2f3; font-family:Arial,sans-serif; }
    #createObjectBtn {
      position:absolute; top:20px; left:20px;
      padding:12px 20px; background:#e67e22; color:#fff;
      border:3px solid #d35400; border-radius:6px;
      font-size:16px; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.3);
      z-index:1000;
    }
    #startStopBtn {
      position:absolute; top:20px; left:140px;
      padding:12px 20px; background:#27ae60; color:#fff;
      border:3px solid #1e8449; border-radius:6px;
      font-size:16px; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.3);
      z-index:1000;
    }
    #ground {
      position:absolute; bottom:0; left:0;
      width:100%; height:120px;
      background:linear-gradient(90deg,#7f8c8d,#bdc3c7);
      border-top:3px solid #2c3e50; z-index:10;
    }
    #leftWall, #rightWall {
      position:absolute; bottom:120px;
      width:20px; height:calc(100% - 120px);
      background:#34495e; z-index:50;
    }
    #leftWall { left:0; }
    #rightWall { right:0; }
    #simulator {
      position:absolute; top:0; left:0;
      width:100%; height:calc(100% - 120px);
      background:#fff; z-index:20;
      overflow: hidden;
    }
    #followBox {
      position:absolute; width:60px; height:60px;
      background:rgba(52,152,219,0.5); border-radius:6px;
      display:none; z-index:900; transform:translate(-50%,0);
    }
    .object {
      position:absolute; width:60px; height:60px;
      background:#3498db; border:2px solid #2c3e50; border-radius:6px;
      display:flex; align-items:center; justify-content:center;
      flex-direction:column; cursor:pointer; user-select:none;
      z-index:800; color:#fff; font-size:12px;
    }
    .label-text { font-size:14px; color:#fff; pointer-events:none; user-select:none; }
    .input-container { display:flex; flex-direction:column; gap:4px; width:100%; }
    .input-with-unit { position:relative; width:100%; }
    .input-with-unit input {
      width:100%; font-size:12px; padding-right:28px; box-sizing:border-box;
    }
    .input-with-unit span {
      position:absolute; right:4px; top:50%; transform:translateY(-50%);
      font-size:10px; color:#555; pointer-events:none;
    }
    .done-btn {
      position:absolute; width:60px; font-size:12px; padding:3px 0;
      border:1px solid #1e8449; background:#27ae60; color:#fff;
      border-radius:4px; cursor:pointer; z-index:1001;
    }
    #alertBox {
      position:fixed; top:-50px; left:50%; transform:translateX(-50%);
      background:rgba(231,76,60,0.7); color:#fff;
      padding:12px 24px; border-radius:6px; font-weight:bold;
      box-shadow:0 2px 6px rgba(0,0,0,0.3); z-index:2000;
      opacity:0.85; animation-fill-mode:forwards;
    }
    @keyframes dropDown {
      0% { top:-50px; opacity:0 }
      50%,100% { top:20px; opacity:1 }
    }
    @keyframes fadeOut {
      from { opacity:1 } to { opacity:0 }
    }
    .arrow {
      position:absolute; font-size:72px; font-weight:bold; color:#000;
      cursor:pointer; user-select:none; z-index:700;
      user-select:none;
    }
  </style>
</head>
<body>
  <button id="createObjectBtn">물체 생성</button>
  <button id="startStopBtn">시작</button>
  <div id="simulator"></div>
  <div id="ground"></div>
  <div id="leftWall"></div>
  <div id="rightWall"></div>
  <div id="followBox"></div>
  <div id="alertBox" style="display:none;"></div>

  <script>
    const createBtn = document.getElementById('createObjectBtn');
    const startStopBtn = document.getElementById('startStopBtn');
    const followBox = document.getElementById('followBox');
    const simulator = document.getElementById('simulator');
    const alertBox = document.getElementById('alertBox');

    const groundHeight = 120;
    const boxSize = 60;
    const leftWallWidth = 20;
    const rightWallWidth = 20;

    let tracking = false;
    let delayPassed = false;
    let animating = false;
    let objects = [];
    let animationId = null;

    // 화살표 간격 (상자와 화살표 사이)
    const gap = -10;

    createBtn.addEventListener('click', () => {
      tracking = !tracking;
      delayPassed = false;
      if (tracking) {
        followBox.style.display = 'block';
        createBtn.textContent = '취소';
        window.addEventListener('mousemove', followMouse);
        setTimeout(() => delayPassed = true, 300);
        window.addEventListener('click', handleClickOnce);
      } else {
        stopTracking();
      }
    });

    function stopTracking() {
      tracking = false;
      delayPassed = false;
      followBox.style.display = 'none';
      createBtn.textContent = '물체 생성';
      window.removeEventListener('mousemove', followMouse);
      window.removeEventListener('click', handleClickOnce);
    }

    function followMouse(e) {
      const y = getBoxY();
      followBox.style.left = e.clientX + 'px';
      followBox.style.top = y + 'px';
    }

    function getBoxY() {
      return window.innerHeight - groundHeight - boxSize + 2;
    }

    function showAlert(msg) {
      alertBox.textContent = msg;
      alertBox.style.display = 'block';
      alertBox.style.animation = 'dropDown 0.5s forwards';
      setTimeout(() => alertBox.style.animation = 'fadeOut 0.5s forwards', 2500);
      alertBox.addEventListener('animationend', () => {
        if (alertBox.style.opacity === '0') {
          alertBox.style.display = 'none';
          alertBox.style.animation = '';
        }
      }, { once: true });
    }

    function handleClickOnce(e) {
      if (!delayPassed) return;

      if (e.target.closest('.object') || e.target === startStopBtn || e.target === createBtn) return;

      const x = e.clientX - boxSize / 2;
      const y = getBoxY();

      const box = document.createElement('div');
      box.className = 'object';
      box.style.left = x + 'px';
      box.style.top = y + 'px';

      // 초기 데이터
      box.mass = null;
      box.velocity = null;
      box.direction = '→';

      // 라벨 영역
      let label = document.createElement('div');
      label.className = 'label-text';
      box.appendChild(label);

      // 입력창 및 완료버튼 상태 플래그
      box.isEditing = false;

      // 화살표 생성
      const arrow = document.createElement('div');
      arrow.className = 'arrow';
      arrow.textContent = box.direction;
      simulator.appendChild(arrow);

      updateArrowPosition(box, arrow);

      // 화살표 클릭시 방향 바꾸기
      arrow.addEventListener('click', (ev) => {
        ev.stopPropagation();
        if (box.direction === '→') box.direction = '←';
        else box.direction = '→';
        arrow.textContent = box.direction;
        updateArrowPosition(box, arrow);
      });

      // 상자 클릭 시 입력창 열기
      box.addEventListener('click', (ev) => {
        ev.stopPropagation();
        if (box.isEditing) return; // 이미 편집 중일 때는 무시
        box.isEditing = true;

        // 입력창 컨테이너
        const inputContainer = document.createElement('div');
        inputContainer.className = 'input-container';

        // 질량 입력
        const massDiv = document.createElement('div');
        massDiv.className = 'input-with-unit';
        const massInput = document.createElement('input');
        massInput.type = 'number';
        massInput.placeholder = '질량';
        massInput.value = box.mass !== null ? box.mass : '';
        massInput.min = '0';
        massInput.step = 'any';
        const kgSpan = document.createElement('span');
        kgSpan.textContent = 'kg';
        massDiv.appendChild(massInput);
        massDiv.appendChild(kgSpan);

        // 속도 입력
        const velocityDiv = document.createElement('div');
        velocityDiv.className = 'input-with-unit';
        const velocityInput = document.createElement('input');
        velocityInput.type = 'number';
        velocityInput.placeholder = '속도';
        velocityInput.value = box.velocity !== null ? box.velocity : '';
        velocityInput.min = '0';
        velocityInput.step = 'any';
        const msSpan = document.createElement('span');
        msSpan.textContent = 'm/s';
        velocityDiv.appendChild(velocityInput);
        velocityDiv.appendChild(msSpan);

        inputContainer.appendChild(massDiv);
        inputContainer.appendChild(velocityDiv);
        box.appendChild(inputContainer);

        // 완료 버튼 생성 및 위치 조정
        const doneBtn = document.createElement('button');
        doneBtn.className = 'done-btn';
        doneBtn.textContent = '완료';
        doneBtn.style.left = box.style.left;
        doneBtn.style.top = (parseFloat(box.style.top) - 30) + 'px';
        simulator.appendChild(doneBtn);

        // 완료 버튼 클릭 이벤트
        doneBtn.onclick = () => {
          const m = massInput.value.trim();
          const v = velocityInput.value.trim();

          if (m === '' && v === '') {
            showAlert('질량과 속도를 입력해 주세요');
            return;
          }
          if (m === '') {
            showAlert('질량을 입력해 주세요');
            return;
          }
          if (v === '') {
            showAlert('속도를 입력해 주세요');
            return;
          }

          box.mass = parseFloat(m);
          box.velocity = parseFloat(v);
          box.direction = box.direction;

          label.textContent = `${m} kg`;

          arrow.style.display = 'block';

          // 입력창과 완료 버튼 즉시 제거
          inputContainer.remove();
          doneBtn.remove();

          box.isEditing = false;
        };

        massInput.focus();
      });

      simulator.appendChild(box);
      objects.push({ box, arrow });

      stopTracking();
    }

    function updateArrowPosition(box, arrow) {
      const boxX = parseFloat(box.style.left);
      const boxY = parseFloat(box.style.top);
      const arrowRect = arrow.getBoundingClientRect();

      if (box.direction === '→') {
        arrow.style.left = (boxX + boxSize + gap) + 'px';
      } else {
        arrow.style.left = (boxX - arrow.offsetWidth - gap) + 'px';
      }
      arrow.style.top = (boxY + (boxSize - arrow.offsetHeight) / 2) + 'px';
    }

    // 움직임 관련
    startStopBtn.addEventListener('click', () => {
      if (!animating) {
        startStopBtn.textContent = '중지';
        startStopBtn.style.background = '#c0392b';
        startStopBtn.style.borderColor = '#922b21';
        animating = true;
        animate();
      } else {
        startStopBtn.textContent = '시작';
        startStopBtn.style.background = '#27ae60';
        startStopBtn.style.borderColor = '#1e8449';
        animating = false;
        if(animationId) cancelAnimationFrame(animationId);
      }
    });

    function animate() {
      objects.forEach(({ box, arrow }) => {
        if (box.mass === null || box.velocity === null) return;

        let posX = parseFloat(box.style.left);
        let vel = box.velocity;
        let dir = box.direction === '→' ? 1 : -1;
        let newPosX = posX + vel * dir;

        // 왼쪽벽 충돌
        if (newPosX <= leftWallWidth) {
          newPosX = leftWallWidth;
          vel = 0;
          box.velocity = 0;
        }

        // 오른쪽벽 충돌
        const maxX = window.innerWidth - rightWallWidth - boxSize;
        if (newPosX >= maxX) {
          newPosX = maxX;
          vel = 0;
          box.velocity = 0;
        }

        box.style.left = newPosX + 'px';
        arrow.style.top = box.style.top;
        box.velocity = vel;

        // 방향에 따라 화살표 위치 갱신
        if (vel === 0) {
          // 멈춘 경우 화살표 유지 위치만 갱신
          updateArrowPosition(box, arrow);
        } else {
          // 이동중이면 방향에 따라 위치 업데이트
          updateArrowPosition(box, arrow);
        }
      });

      if (animating) {
        animationId = requestAnimationFrame(animate);
      }
    }
  </script>
</body>
</html>
